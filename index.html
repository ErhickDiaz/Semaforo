  <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Panel de Transporte</title>
<style>
  table {
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    padding: 6px;
    border: 1px solid #ddd;
    text-align: center;
  }
  .semaforo-rojo {
    background-color: #f44336;
    color: white;
  }
  .semaforo-amarillo {
    background-color: #ffeb3b;
  }
  .semaforo-verde {
    background-color: #4caf50;
    color: white;
  }
  .fecha-actualizacion {
    font-style: italic;
    font-size: 0.9em;
  }
</style>
</head>
<body>

<h2>Panel de Transporte - Filtro Retorno</h2>

<div>
  <label for="filtro">Selecciona filtro: </label>
  <select id="filtro" onchange="mostrarDatos()">
    <option value="Retorno">Retorno</option>
    <!-- otros filtros si aplican -->
  </select>
</div>

<table id="tabla-datos">
  <thead id="tabla-head"></thead>
  <tbody id="tabla-body"></tbody>
</table>

<script>
  let datosRetorno = [];
  let datosViajes = [];

  const columnasPorFiltro = {
    "Retorno": ["Patente", "Hora Programada", "ETA", "Semáforo", "Última Actualización", "Paso Por Chillan"]
  };

  // Función para cargar CSV (sin librerías externas)
  async function cargarCSV(url, separador = ",") {
    const respuesta = await fetch(url);
    const texto = await respuesta.text();
    const lineas = texto.trim().split('\n');
    return lineas.map(linea => linea.split(separador).map(c => c.trim()));
  }

  // Función para asignar clase semáforo según estado o tiempos
  function obtenerClaseSemaforo(semaforo) {
    switch (semaforo.toLowerCase()) {
      case "rojo": return "semaforo-rojo";
      case "amarillo": return "semaforo-amarillo";
      case "verde": return "semaforo-verde";
      default: return "";
    }
  }

  async function cargarDatos() {
    // Carga retorno.csv (contiene paso_por_chillan)
    datosRetorno = await cargarCSV('retorno.csv', ',');

    // Carga viajes.csv (contiene ETA, Semáforo, Última actualización)
    datosViajes = await cargarCSV('viajes.csv', ',');

    // Crear mapa para lookup rápido por patente (asumo patente en columna 0 en ambos)
    const mapaViajes = new Map();
    datosViajes.forEach(fila => {
      const patente = fila[0].toUpperCase();
      mapaViajes.set(patente, {
        eta: fila[2] || "-",
        semaforo: fila[3] || "-",
        ultimaAct: fila[4] || "-"
      });
    });

    // Combinar datos para filtro Retorno: [Patente, Hora Prog, ETA, Semáforo, Última Actualización, Paso Por Chillan]
    datosRetorno = datosRetorno.map(fila => {
      const patente = fila[0].toUpperCase();
      const horaProg = fila[2] || "-";
      const pasoChillan = fila[3] || "NO";
      const viaje = mapaViajes.get(patente) || {eta: "-", semaforo: "-", ultimaAct: "-"};
      return [patente, horaProg, viaje.eta, viaje.semaforo, viaje.ultimaAct, pasoChillan];
    });

    mostrarDatos();
  }

  function mostrarDatos() {
    const filtro = document.getElementById('filtro').value;
    const columnas = columnasPorFiltro[filtro];

    // Construir encabezado
    const thead = document.getElementById('tabla-head');
    thead.innerHTML = '';
    const trHead = document.createElement('tr');
    columnas.forEach(col => {
      const th = document.createElement('th');
      th.textContent = col;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    // Construir cuerpo
    const tbody = document.getElementById('tabla-body');
    tbody.innerHTML = '';

    datosRetorno.forEach(fila => {
      const tr = document.createElement('tr');
      columnas.forEach(col => {
        const td = document.createElement('td');
        let valor = "-";

        switch(col) {
          case "Patente": valor = fila[0]; break;
          case "Hora Programada": valor = fila[1]; break;
          case "ETA": valor = fila[2]; break;
          case "Semáforo":
            valor = fila[3];
            td.className = obtenerClaseSemaforo(valor);
            break;
          case "Última Actualización": 
            valor = fila[4];
            td.className = 'fecha-actualizacion';
            break;
          case "Paso Por Chillan":
            valor = fila[5];
            break;
        }

        td.textContent = valor;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  cargarDatos();
</script>

</body>
</html>
